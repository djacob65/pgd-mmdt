// ***********************************
// BioPortal Widget code
// ***********************************

var bioportal_sites = [
	{
		BP_NAME: "bioportal",
		BP_SEARCH_SERVER: "https://bioportal.bioontology.org",
		BP_ONTOLOGIES: "",
		BP_MAXITEMS: 30,
		BP_matchString: "bp_ontology",
		BP_ORG_SITE: "BioPortal NCBO"
	},
	{
		BP_NAME: "agroportal",
		BP_SEARCH_SERVER: "https://agroportal.lirmm.fr/",
		BP_ONTOLOGIES: "",
		BP_MAXITEMS: 30,
		BP_matchString: "ag_ontology",
		BP_ORG_SITE: "AgroPortal LIRMM"
	}
]

$((function(){$.bioportal_autocomplete=function(e,t){var a=$(e).attr("autocomplete","off");t.inputClass&&a.addClass(t.inputClass);var n=document.createElement("div"),l=$(n);l.hide().addClass(t.resultsClass).css("position","absolute"),l.addClass(a.attr("name")),t.width>0&&l.css("width",t.width),$("body").append(n),e.autocompleter=this;var s=null,r="",o=-1,i={},c=!1,u=null;function f(){(i={}).data={},i.length=0}if(f(),null!=t.data){var d="",h={},p=[];"string"!=typeof t.url&&(t.cacheLength=1);for(var m=0;m<t.data.length;m++)(p="string"==typeof t.data[m]?[t.data[m]]:t.data[m])[0].length>0&&(h[d=p[0].substring(0,1).toLowerCase()]||(h[d]=[]),h[d].push(p));for(var v in h)t.cacheLength++,P(v,h[v])}function g(e){var t=$("li",n);t&&((o+=e)<0?o=0:o>=t.size()&&(o=t.size()-1),t.removeClass("ac_over"),$(t[o]).addClass("ac_over"))}function C(n){n||((n=document.createElement("li")).extra=[],n.selectValue="");var s=$.trim(n.selectValue?n.selectValue:n.innerHTML);e.lastSelected=s,r=s,l.html(""),a.val(s),_(),setTimeout((function(){$("#"+$(e).attr("name")+t.hidden_field).val(n.extra[4])}),1),setTimeout((function(){$(document).trigger("autocomplete_selected",t.extraParams)}),2)}function x(e){8!=u&&(a.val(a.val()+e.substring(r.length)),function(e,t){var n=a.get(0);if(n.createTextRange){var l=n.createTextRange();l.collapse(!0),l.moveStart("character",e),l.moveEnd("character",t),l.select()}else n.setSelectionRange?n.setSelectionRange(e,t):n.selectionStart&&(n.selectionStart=e,n.selectionEnd=t);n.focus()}(r.length,e.length))}function b(){var n=function(e){var t=e.offsetLeft||0,a=e.offsetTop||0;for(;e=e.offsetParent;)t+=e.offsetLeft,a+=e.offsetTop;return{x:t,y:a}}(e),s=t.width>0?t.width:a.width();void 0!==t.header&&l.prepend(t.header),void 0!==t.footer&&l.append(t.footer),l.css({width:parseInt(s)+"px",top:n.y+e.offsetHeight+"px",left:n.x+"px"}).css("display","block"),setTimeout((function(){$(document).trigger("show_results")}),2)}function _(){(s&&clearTimeout(s),a.removeClass(t.loadingClass),l.css("display","none"),t.mustMatch)&&(a.val()!=e.lastSelected&&a.addClass("help_text_font").val(a.attr("title")))}function y(e,l){if(l){if(a.removeClass(t.loadingClass),n.innerHTML="",!c)return _();0==l.length&&n.appendChild("<div style='padding: 5px; font-size: normal; font-style: oblique;'>No results found</div>"),n.appendChild(function(e){var a=document.createElement("ul"),n=e.length;t.maxItemsToShow>0&&t.maxItemsToShow<n&&(n=t.maxItemsToShow);for(var l=0;l<n;l++){var s=e[l];if(s){var r=document.createElement("li");r.innerHTML=I(s),r.selectValue=s[0];var i=null;if(s.length>1){i=[];for(var c=1;c<s.length;c++)i[i.length]=s[c]}r.extra=i,a.appendChild(r),$(r).hover((function(){$("li",a).removeClass("ac_over"),$(this).addClass("ac_over"),o=$("li",a).indexOf($(this).get(0))}),(function(){$(this).removeClass("ac_over")})).click((function(e){e.preventDefault(),e.stopPropagation(),C(this)}))}}return a}(l)),t.autoFill&&a.val().toLowerCase()==e.toLowerCase()&&x(l[0][0]),b()}else a.removeClass(t.loadingClass),n.innerHTML="<div style='padding: 5px; font-size: normal; font-style: oblique;'>No results found</div>",b()}function w(e){if(!e)return null;for(var a=[],n=e.split(t.lineSeparator),l=0;l<n.length;l++){var s=$.trim(n[l]);s&&(a[a.length]=s.split(t.cellSeparator))}return a}function S(e){var a=t.url+"?q="+encodeURI(e);for(var n in t.extraParams)a+="&"+n+"="+encodeURI(t.extraParams[n]);return a}function L(e){if(!e)return null;if(i.data[e])return i.data[e];if(t.matchSubset)for(var a=e.length-1;a>=t.minChars;a--){var n=e.substr(0,a),l=i.data[n];if(l){for(var s=[],r=0;r<l.length;r++){var o=l[r];T(o[0],e)&&(s[s.length]=o)}return s}}return null}function T(e,a){t.matchCase||(e=e.toLowerCase());var n=e.indexOf(a);return-1!=n&&(0==n||t.matchContains)}function E(e,n){n&&a.removeClass(t.loadingClass);for(var l=n?n.length:0,s=null,r=0;r<l;r++){var o=n[r];if(o[0].toLowerCase()==e.toLowerCase()){(s=document.createElement("li")).innerHTML=I(o),s.selectValue=o[0];var i=null;if(o.length>1){i=[];for(var c=1;c<o.length;c++)i[i.length]=o[c]}s.extra=i}}t.onFindValue&&setTimeout((function(){t.onFindValue(s)}),1)}function P(e,a){a&&e&&t.cacheLength&&(!i.length||i.length>t.cacheLength?(f(),i.length++):i[e]||i.length++,i.data[e]=a)}function I(e){var n=null,l=a.attr("class").split(" ");$(l).each((function(){if(0===this.indexOf(t.matchString)){var e=this.split("-");n=decodeURIComponent(e[1])}})),"all"==n&&(n="");var s=$("<span>");s.attr("style","font-size:9px;color:blue;"),void 0!==e[2]&&""!==e[2]&&s.text(e[2]);var r=new RegExp("[.*+?|()\\[\\]{}\\\\]","g"),o=a.val().trim().replace(r,"\\$&").split(" ").join("|"),i=new RegExp("("+o+")","gi");if(null==e[0].match(i)){var c=e[6].split("\t")[0]||"";if(""!==(c=c.split(";"))){var u=$.grep(c,(function(e){return null!=e.match(i)}));e[0]=e[0]+" (synonyms: "+u.join(", ")+")"}}-1!=e[0].indexOf("[obsolete]")?(e[0]=e[0].replace("[obsolete]",""),obsolete_prefix="<span class='obsolete_class' title='obsolete class'>",obsolete_suffix="</span>"):(obsolete_prefix="",obsolete_suffix="");var f=e[0].replace(i,"<b><span style='color:#006600;'>$1</span></b>");var d=$("<span>");d.addClass("result_class"),d.html(f);var h=$("<div>");e[3],e[4];h.append(d);var p=$("<span>");return p.addClass("result_ontology"),p.attr("style","overflow: hidden;"),p.html("("+e[3]+")"),h.append(p),obsolete_prefix+h.html()+obsolete_suffix}a.keydown((function(e){switch(u=e.keyCode,e.keyCode){case 38:e.preventDefault(),g(-1);break;case 40:e.preventDefault(),g(1);break;case 9:case 13:(function(){var e=$("li.ac_over",n)[0];if(!e){var a=$("li",n);t.selectOnly?1==a.length&&(e=a[0]):t.selectFirst&&(e=a[0])}return!!e&&(C(e),!0)})()&&(a.get(0).blur(),e.preventDefault());break;default:o=-1,s&&clearTimeout(s),s=setTimeout((function(){!function(){if(46==u||u>8&&u<32)return l.css("display","none");var e=a.val();if(e==r)return;r=e,e.length>=t.minChars?(a.addClass(t.loadingClass),function(e){t.matchCase||(e=e.toLowerCase());var n=t.cacheLength?L(e):null;n?y(e,n):"string"==typeof t.url&&t.url.length>0?$.getJSON(S(e)+"&response=json&callback=?",(function(t){t=w(t.data),P(e,t),y(e,t)})):a.removeClass(t.loadingClass)}(e)):(a.removeClass(t.loadingClass),l.css("display","none"))}()}),t.delay)}})).focus((function(){c=!0})).blur((function(){c=!1,function(){s&&clearTimeout(s);s=setTimeout(_,200)}()})),this.flushCache=function(){f()},this.setExtraParams=function(e){t.extraParams=e},this.getExtraParams=function(){return t.extraParams},this.getOptions=function(){return t},this.findValue=function(){var e=a.val();t.matchCase||(e=e.toLowerCase());var n=t.cacheLength?L(e):null;n?E(e,n):"string"==typeof t.url&&t.url.length>0?$.get(S(e),(function(t){t=w(t),P(e,t),E(e,t)})):E(e,null)}},$.fn.bioportal_autocomplete=function(e,t,a){return(t=t||{}).url=e,t.data="object"==typeof a&&a.constructor==Array?a:null,t.inputClass=t.inputClass||"ac_input",t.resultsClass=t.resultsClass||"ac_results",t.lineSeparator=t.lineSeparator||"\n",t.cellSeparator=t.cellSeparator||"|",t.minChars=t.minChars||1,t.delay=t.delay||400,t.matchString=t.matchString||"bp_ontology",t.hidden_field=t.hidden_field||"_preferred_name",t.matchCase=t.matchCase||0,t.matchSubset=t.matchSubset||0,t.matchContains=t.matchContains||0,t.cacheLength=t.cacheLength||1,t.mustMatch=t.mustMatch||0,t.extraParams=t.extraParams||{},t.loadingClass=t.loadingClass||"ac_loading",t.selectFirst=t.selectFirst||!1,t.selectOnly=t.selectOnly||!1,t.maxItemsToShow=t.maxItemsToShow||-1,t.autoFill=t.autoFill||!1,t.width=parseInt(t.width,10)||0,this.each((function(){new $.bioportal_autocomplete(this,t)})),this},$.fn.bioportal_autocompleteArray=function(e,t){return this.bioportal_autocomplete(null,t,e)},$.fn.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1}}));function bioportal_setup(){for(var t=0;t<bioportal_sites.length;t++)bp=bioportal_sites[t],$("input[class^='"+bp.BP_matchString+"']").each((function(){var t,e,a,r=this.className.split(" ");$(r).each((function(){0===this.indexOf(bp.BP_matchString)&&(t=this.split("-"),e=decodeURIComponent(t[1]),a=t[2])})),"all"==e&&(e="");var i={input:this,target_property:a,ontologies:e},n=450;""===e&&(n+=200),$(this).bioportal_autocomplete(bp.BP_SEARCH_SERVER+"/search/json_search/",{extraParams:i,lineSeparator:"~!~",matchSubset:0,minChars:3,maxItemsToShow:bp.BP_MAXITEMS,width:n,footer:'<div style="color: grey; font-size: 8pt; font-family: Verdana; padding: .8em .5em .3em;">Results provided by <a style="color: grey;" href="'+bp.BP_SEARCH_SERVER+'">'+bp.BP_ORG_SITE+"</a></div>",matchString:bp.BP_matchString,hidden_field:"_preferred_name"});var o="";null==document.getElementById($(this).attr("name")+"_preferred_name")&&(o+="<input type='hidden' id='"+$(this).attr("name")+"_preferred_name'>"),$(this).after(o)}))}